<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Caminando la Palabra</title>

  <!-- Firebase compat (fácil para HTML simple) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <style>
    :root{
      --primary:#004aad;
      --accent:#28a745;
      --muted:#f4f4f9;
    }
    *{box-sizing:border-box}
    body{font-family:Arial, sans-serif;margin:0;background:var(--muted);min-height:100vh;display:flex;flex-direction:column}
    /* Selección perfil */
    #perfil-container{display:flex;align-items:center;justify-content:center;height:100vh;background:linear-gradient(135deg,#6a11cb,#2575fc);color:#fff;flex-direction:column;text-align:center}
    .btn{padding:12px 22px;border-radius:30px;border:none;cursor:pointer;margin:8px;font-weight:700;box-shadow:0 6px 14px rgba(0,0,0,0.12)}
    .btn-educacion{background:var(--accent);color:#fff}
    .btn-emprendimiento{background:#ffc107;color:#111}

    /* Nav */
    nav{background:#222;color:#fff;display:flex;justify-content:space-between;align-items:center;padding:10px 18px;position:sticky;top:0;z-index:10}
    nav .titulo{font-weight:700}
    nav .perfil-link{color:#ffc107;cursor:pointer;text-decoration:underline}
    nav .menu button{margin-left:10px;border-radius:20px;padding:8px 12px;border:none;background:rgba(255,255,255,0.06);color:#fff;cursor:pointer}

    /* Layout */
    .container{padding:18px;flex:1}
    .card{background:#fff;border-radius:12px;padding:18px;box-shadow:0 6px 18px rgba(0,0,0,0.06);max-width:1100px;margin:18px auto}
    input, select, textarea{width:100%;padding:10px;margin:8px 0;border-radius:10px;border:1px solid #ddd}
    label{font-weight:600;font-size:14px}
    .row{display:flex;gap:12px}
    .row .col{flex:1}

    table{width:100%;border-collapse:collapse;background:#fff;margin-top:12px}
    th,td{padding:10px;border:1px solid #e6e6e6;text-align:center}
    th{background:var(--primary);color:#fff}

    footer{text-align:center;padding:12px;background:#111;color:#fff}

    /* Push-up modal (desde abajo) */
    .modal{position:fixed;left:0;right:0;bottom:0;background:rgba(0,0,0,0.45);display:none;align-items:flex-end;justify-content:center;padding:12px}
    .modal .contenido{background:#fff;border-radius:12px;padding:16px;width:100%;max-width:680px;box-shadow:0 -6px 30px rgba(0,0,0,0.3)}
    .modal.show{display:flex}

    /* Estados resumen */
    .estado-rojo{color:red;font-weight:700}
    .estado-amarillo{text-decoration:underline;text-decoration-color:yellow;font-weight:700}
    .estado-verde{text-decoration:underline;text-decoration-color:green;font-weight:700}

    /* Botones bonitos */
    .primary-btn{background:var(--primary);color:#fff;padding:10px 14px;border-radius:999px;border:none;cursor:pointer}
    .danger-btn{background:#e13b3b;color:#fff;padding:10px 14px;border-radius:999px;border:none;cursor:pointer}
    .muted-btn{background:#f0f0f0;color:#222;padding:10px 14px;border-radius:999px;border:none;cursor:pointer}

    @media (max-width:900px){ .row{flex-direction:column} table,th,td{font-size:13px} }
  </style>
</head>
<body>

  <!-- Selección perfil -->
  <div id="perfil-container">
    <h1 style="margin:0 0 12px 0">Elige un perfil</h1>
    <div>
      <button class="btn btn-educacion" onclick="entrarPerfil('Educación')">Perfil de Educación</button>
      <button class="btn btn-emprendimiento" onclick="entrarPerfil('Emprendimiento')">Perfil de Emprendimiento</button>
    </div>
  </div>

  <!-- App -->
  <div id="app" style="display:none">
    <nav>
      <div class="titulo" id="app-title">CAMINANDO LA PALABRA</div>
      <div style="display:flex;align-items:center">
        <div style="margin-right:12px">(<span class="perfil-link" id="perfil-link" onclick="volverSeleccion()"></span>)</div>
        <div class="menu">
          <button class="primary-btn" onclick="showSection('registro')">Registro</button>
          <button class="primary-btn" onclick="showSection('estudiantes')">Estudiantes</button>
          <button class="primary-btn" onclick="showSection('asistencia')">Asistencia</button>
          <button class="primary-btn" onclick="showSection('resumen')">Resumen</button>
        </div>
      </div>
    </nav>

    <div class="container">
      <!-- Registro -->
      <div id="registro" class="card section">
        <h2>Registrar estudiante</h2>
        <div class="row">
          <div class="col">
            <label>Nombres</label>
            <input id="nombres" placeholder="Nombres" />
          </div>
          <div class="col">
            <label>Apellidos</label>
            <input id="apellidos" placeholder="Apellidos" />
          </div>
        </div>

        <div class="row">
          <div class="col">
            <label>Edad</label>
            <input id="edad" type="number" placeholder="Edad" />
          </div>
          <div class="col">
            <label>Nombre del acudiente</label>
            <input id="acudiente" placeholder="Acudiente" />
          </div>
        </div>

        <div class="row">
          <div class="col">
            <label>Teléfono (opcional)</label>
            <input id="telefono" placeholder="Teléfono" />
          </div>
          <div class="col">
            <label>Fecha de inicio</label>
            <input id="fechaInicio" type="date" />
          </div>
        </div>

        <div style="margin-top:12px;display:flex;gap:10px;justify-content:flex-end">
          <button class="primary-btn" onclick="registrarEstudiante()">Registrar</button>
          <button class="muted-btn" onclick="limpiarRegistro()">Limpiar</button>
        </div>
        <p id="msgRegistro" style="color:green;font-weight:700;margin-top:8px"></p>
      </div>

      <!-- Estudiantes -->
      <div id="estudiantes" class="card section" style="display:none">
        <h2>Estudiantes</h2>
        <div style="display:flex;gap:12px;align-items:center;margin-bottom:8px">
          <input id="buscarEstudiantes" placeholder="Buscar por nombre o apellido..." oninput="renderEstudiantes()" />
        </div>
        <table>
          <thead>
            <tr>
              <th>Apellidos</th>
              <th>Nombres</th>
              <th>Edad</th>
              <th>Ingreso</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="tablaEstudiantes"></tbody>
        </table>
      </div>

      <!-- Asistencia -->
      <div id="asistencia" class="card section" style="display:none">
        <h2>Registro de asistencia</h2>
        <div class="row">
          <div class="col">
            <label>Fecha</label>
            <input id="fechaAsistencia" type="date" onchange="loadAttendanceForDate()" />
          </div>
          <div class="col">
            <label>Buscar estudiante (para marcar)</label>
            <input id="buscarAsistencia" placeholder="Buscar..." oninput="renderAsistenciaTable()" />
          </div>
        </div>

        <table>
          <thead>
            <tr>
              <th>Apellidos</th>
              <th>Nombres</th>
              <th>Edad</th>
              <th>Asistencia</th>
            </tr>
          </thead>
          <tbody id="tablaAsistencia"></tbody>
        </table>

        <div style="margin-top:12px;display:flex;justify-content:flex-end;gap:10px">
          <button class="primary-btn" onclick="guardarAsistencia()">Grabar asistencia</button>
          <button class="muted-btn" onclick="clearAttendanceDate()">Limpiar fecha</button>
        </div>
      </div>

      <!-- Resumen -->
      <div id="resumen" class="card section" style="display:none">
        <h2>Resumen de asistencias</h2>
        <p id="resumenInfo" style="margin:6px 0;color:#555"></p>
        <div style="margin-bottom:8px">
          <input id="buscarResumen" placeholder="Buscar..." oninput="renderResumen()" />
        </div>
        <table>
          <thead>
            <tr>
              <th>Apellidos</th>
              <th>Nombres</th>
              <th>Edad</th>
              <th>Total asistencias</th>
              <th>Estado</th>
            </tr>
          </thead>
          <tbody id="tablaResumen"></tbody>
        </table>
      </div>

    </div>

    <!-- Modal push-up (edición) -->
    <div id="modalEditar" class="modal">
      <div class="contenido">
        <h3>Editar estudiante</h3>
        <div class="row">
          <div class="col"><input id="editNombres" placeholder="Nombres" /></div>
          <div class="col"><input id="editApellidos" placeholder="Apellidos" /></div>
        </div>
        <div class="row">
          <div class="col"><input id="editEdad" type="number" placeholder="Edad" /></div>
          <div class="col"><input id="editAcudiente" placeholder="Acudiente" /></div>
        </div>
        <input id="editTelefono" placeholder="Teléfono (opcional)" />
        <input id="editFechaInicio" type="date" />
        <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
          <button class="primary-btn" onclick="guardarEdicion()">Guardar</button>
          <button class="danger-btn" onclick="eliminarEstudianteActual()">Eliminar</button>
          <button class="muted-btn" onclick="cerrarModal()">Cerrar</button>
        </div>
      </div>
    </div>

    <footer>© Jesús Forero 2025</footer>
  </div>

  <!-- ---------- Firebase + App logic ---------- -->
  <script>
    // ---------- 1) REEMPLAZA con tu firebaseConfig (desde Firebase console -> Add web app) ----------
    const firebaseConfig = {
      apiKey: "AIzaSyAgawhVDhT7saspifJE9gZFHEV-1sCAtio",
      authDomain: "caminando-palabra.firebaseapp.com",
      projectId: "caminando-palabra"
    };
    // -----------------------------------------------------------------------------------------

    // Inicializar Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Estado en memoria
    let perfil = "";
    let estudiantesCache = []; // cache local
    let currentEditId = null;
    let unsubscribeListener = null;
    let attendanceForDate = []; // ids

    // ---------- Util: escape HTML ----------
    function escapeHtml(text){ if(!text) return ''; return text.replace(/[&<>"']/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]}); }

    // ---------- Selección perfil ----------
    function entrarPerfil(tipo){
      perfil = tipo;
      document.getElementById('perfil-container').style.display = 'none';
      document.getElementById('app').style.display = 'block';
      document.getElementById('perfil-link').innerText = `Perfil de ${tipo}`;
      showSection('registro');
      attachListenerForPerfil();
    }

    function volverSeleccion(){
      // unsubscribe if exists
      if(unsubscribeListener) unsubscribeListener();
      document.getElementById('perfil-container').style.display = 'flex';
      document.getElementById('app').style.display = 'none';
      perfil = "";
    }

    function showSection(id){
      document.querySelectorAll('.section').forEach(s => s.style.display = 'none');
      document.getElementById(id).style.display = 'block';
      if(id === 'estudiantes') renderEstudiantes();
      if(id === 'asistencia') renderAsistenciaTable();
      if(id === 'resumen') renderResumen();
    }

    // ---------- Listener real-time por perfil ----------
    function attachListenerForPerfil(){
      if(unsubscribeListener) unsubscribeListener();
      unsubscribeListener = db.collection('estudiantes').where('perfil','==',perfil)
        .onSnapshot(snap => {
          estudiantesCache = snap.docs.map(d => ({ id: d.id, ...d.data() }));
          // actualizar vistas activas
          renderEstudiantes();
          renderAsistenciaTable();
          renderResumen();
        }, err => {
          console.error("Firestore listener error:", err);
        });
    }

    // ---------- Registro ----------
    async function registrarEstudiante(){
      const nombres = document.getElementById('nombres').value.trim();
      const apellidos = document.getElementById('apellidos').value.trim();
      const edad = Number(document.getElementById('edad').value) || null;
      const acudiente = document.getElementById('acudiente').value.trim();
      const telefono = document.getElementById('telefono').value.trim();
      const fechaInicio = document.getElementById('fechaInicio').value;

      if(!nombres || !apellidos || !edad || !acudiente || !fechaInicio){
        document.getElementById('msgRegistro').innerText = "⚠️ Completa los campos requeridos";
        return;
      }

      try{
        await db.collection('estudiantes').add({
          nombres, apellidos, edad, acudiente, telefono, fechaInicio, perfil, asistencias: {}
        });
        document.getElementById('msgRegistro').innerText = "✅ Registro exitoso";
        limpiarRegistro();
      }catch(e){
        console.error("Error al guardar:", e);
        alert("Error al guardar. Revisa consola.");
      }
    }

    function limpiarRegistro(){
      ['nombres','apellidos','edad','acudiente','telefono','fechaInicio'].forEach(id => {
        const el = document.getElementById(id);
        if(el) el.value = '';
      });
      setTimeout(()=> document.getElementById('msgRegistro').innerText = '', 3000);
    }

    // ---------- Render estudiantes ----------
    function renderEstudiantes(){
      const q = (document.getElementById('buscarEstudiantes')?.value || '').toLowerCase();
      const tbody = document.getElementById('tablaEstudiantes');
      if(!tbody) return;
      tbody.innerHTML = '';
      estudiantesCache.filter(e => {
        if(!q) return true;
        return (e.nombres||'').toLowerCase().includes(q) || (e.apellidos||'').toLowerCase().includes(q);
      }).forEach(e => {
        const tiempo = calcularTiempo(e.fechaInicio);
        tbody.insertAdjacentHTML('beforeend', `
          <tr data-id="${e.id}">
            <td>${escapeHtml(e.apellidos)}</td>
            <td>${escapeHtml(e.nombres)}</td>
            <td>${e.edad || ''}</td>
            <td>${tiempo}</td>
            <td>
              <button class="primary-btn" onclick="abrirEditar('${e.id}')">Editar</button>
              <button class="danger-btn" onclick="borrarEstudiante('${e.id}')">Eliminar</button>
            </td>
          </tr>
        `);
      });
    }

    // ---------- Edit modal ----------
    async function abrirEditar(id){
      currentEditId = id;
      const doc = await db.collection('estudiantes').doc(id).get();
      const e = doc.data();
      document.getElementById('editNombres').value = e.nombres || '';
      document.getElementById('editApellidos').value = e.apellidos || '';
      document.getElementById('editEdad').value = e.edad || '';
      document.getElementById('editAcudiente').value = e.acudiente || '';
      document.getElementById('editTelefono').value = e.telefono || '';
      document.getElementById('editFechaInicio').value = e.fechaInicio || '';
      document.getElementById('modalEditar').classList.add('show');
    }

    function cerrarModal(){
      document.getElementById('modalEditar').classList.remove('show');
      currentEditId = null;
    }

    async function guardarEdicion(){
      if(!currentEditId) return;
      const nombres = document.getElementById('editNombres').value.trim();
      const apellidos = document.getElementById('editApellidos').value.trim();
      const edad = Number(document.getElementById('editEdad').value) || null;
      const acudiente = document.getElementById('editAcudiente').value.trim();
      const telefono = document.getElementById('editTelefono').value.trim();
      const fechaInicio = document.getElementById('editFechaInicio').value;

      try{
        await db.collection('estudiantes').doc(currentEditId).update({
          nombres, apellidos, edad, acudiente, telefono, fechaInicio
        });
        cerrarModal();
      }catch(e){
        console.error("Error actualizando:", e);
        alert("Error actualizando. Revisa consola.");
      }
    }

    // ---------- Borrar estudiante ----------
    async function borrarEstudiante(id){
      if(!confirm("¿Eliminar estudiante?")) return;
      try{
        await db.collection('estudiantes').doc(id).delete();
        // Como las asistencias están dentro del documento, ya se elimina con el estudiante
      }catch(e){
        console.error("Error eliminando:", e);
        alert("Error al eliminar");
      }
    }

    async function eliminarEstudianteActual(){
      if(currentEditId) await borrarEstudiante(currentEditId);
      cerrarModal();
    }

    // ---------- Asistencia ----------
    // carga la lista de asistentes para la fecha seleccionada
    async function loadAttendanceForDate(){
      const date = document.getElementById('fechaAsistencia').value;
      attendanceForDate = [];
      if(!date){
        renderAsistenciaTable();
        return;
      }
      // attendance stored per student inside field 'asistencias': { '2025-09-24': true, ... }
      // No doc separate per day; read each student in cache
      // build attendanceForDate from students cache
      attendanceForDate = estudiantesCache.filter(e => e.asistencias && e.asistencias[date]).map(e => e.id);
      renderAsistenciaTable();
    }

    function renderAsistenciaTable(){
      const q = (document.getElementById('buscarAsistencia')?.value || '').toLowerCase();
      const tbody = document.getElementById('tablaAsistencia');
      if(!tbody) return;
      tbody.innerHTML = '';
      const date = document.getElementById('fechaAsistencia').value;
      estudiantesCache.filter(e => {
        if(!q) return true;
        return (e.nombres||'').toLowerCase().includes(q) || (e.apellidos||'').toLowerCase().includes(q);
      }).forEach(e => {
        const checked = (date && e.asistencias && e.asistencias[date]) ? 'checked' : '';
        tbody.insertAdjacentHTML('beforeend', `
          <tr data-id="${e.id}">
            <td>${escapeHtml(e.apellidos)}</td>
            <td>${escapeHtml(e.nombres)}</td>
            <td>${e.edad || ''}</td>
            <td><input type="checkbox" id="asis-${e.id}" ${checked} /></td>
          </tr>
        `);
      });
    }

    async function guardarAsistencia(){
      const date = document.getElementById('fechaAsistencia').value;
      if(!date){ alert("⚠️ Selecciona una fecha antes de guardar"); return; }

      // recorre todos los estudiantes visibles (preferimos la cache)
      const docs = estudiantesCache.slice(); // array
      try{
        // actualizar cada documento individualmente (podría optimizarse con batch)
        for(const e of docs){
          const checkbox = document.getElementById('asis-' + e.id);
          if(!checkbox) continue;
          const asistio = !!checkbox.checked;
          // solo actualizamos si hay cambio o si no existe la propiedad
          // guardamos la propiedad asistencias.<date>
          const updateObj = {};
          updateObj[`asistencias.${date}`] = asistio;
          await db.collection('estudiantes').doc(e.id).update(updateObj);
        }
        alert("✅ Asistencia guardada");
      }catch(err){
        console.error("Error guardando asistencia:", err);
        alert("Error guardando asistencia. Revisa consola.");
      }
    }

    function clearAttendanceDate(){
      document.getElementById('fechaAsistencia').value = '';
      attendanceForDate = [];
      renderAsistenciaTable();
    }

    // ---------- Resumen ----------
    function renderResumen(){
      const q = (document.getElementById('buscarResumen')?.value || '').toLowerCase();
      const tbody = document.getElementById('tablaResumen');
      tbody.innerHTML = '';
      // compute total days (unique dates across all students)
      const dateSet = new Set();
      estudiantesCache.forEach(e => {
        if(e.asistencias) Object.keys(e.asistencias).forEach(d => dateSet.add(d));
      });
      const totalDays = dateSet.size;

      // compute counts per student
      const lista = estudiantesCache.map(e => {
        const count = Object.values(e.asistencias || {}).filter(v => v).length;
        return {...e, asistenciasCount: count};
      });

      // filter by search
      const filtered = lista.filter(e => {
        if(!q) return true;
        return (e.nombres||'').toLowerCase().includes(q) || (e.apellidos||'').toLowerCase().includes(q);
      });

      // sort desc by asistenciasCount
      filtered.sort((a,b)=> b.asistenciasCount - a.asistenciasCount);

      document.getElementById('resumenInfo').innerText = `Días registrados: ${totalDays}`;

      filtered.forEach(e => {
        const pct = totalDays ? Math.round((e.asistenciasCount / totalDays) * 100) : 0;
        let estadoHtml = '';
        if (pct < 25) estadoHtml = `<span class="estado-rojo">Estudiante</span>`;
        else if (pct < 60) estadoHtml = `<span class="estado-amarillo">Estudiante</span>`;
        else estadoHtml = `<span class="estado-verde">Estudiante</span>`;

        tbody.insertAdjacentHTML('beforeend', `
          <tr data-id="${e.id}">
            <td>${escapeHtml(e.apellidos||'')}</td>
            <td>${escapeHtml(e.nombres||'')}</td>
            <td>${e.edad || ''}</td>
            <td>${e.asistenciasCount || 0}</td>
            <td>${estadoHtml}</td>
          </tr>
        `);
      });
    }

    // ---------- Helpers ----------
    function calcularTiempo(fecha){
      if(!fecha) return '';
      const inicio = new Date(fecha);
      const hoy = new Date();
      const diff = hoy - inicio;
      const dias = Math.floor(diff / (1000*60*60*24));
      return `${dias} días`;
    }

    // ---------- Inicial ----------
    window.addEventListener('load', () => {
      // nothing: we wait perfil selection
    });

  </script>
</body>
</html>



